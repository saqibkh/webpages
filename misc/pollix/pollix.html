<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Pollix - Interactive Polling</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/qrcode"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-gradient-to-b from-indigo-900 to-indigo-700 min-h-screen text-white p-6">

<h1 class="text-3xl font-bold mb-6 text-center">Pollix</h1>

<!-- HOST PANEL -->
<div id="hostPanel" class="max-w-3xl mx-auto bg-indigo-800 p-6 rounded-lg shadow-lg">
  <h2 class="text-2xl font-semibold mb-4">Create a Poll</h2>
  <input id="pollTitle" type="text" placeholder="Poll Title" class="p-2 rounded w-full text-black mb-3">

  <div id="questionsContainer" class="space-y-4 mb-3"></div>
  <button id="addQuestionBtn" class="bg-blue-500 px-3 py-1 rounded hover:bg-blue-600 transition mb-3">Add Question</button>

  <label class="flex items-center gap-2 mb-3">
    <input type="checkbox" id="allowAnonymous" checked>
    Allow anonymous submissions
  </label>

  <input id="pollTimer" type="number" placeholder="Timer (seconds, optional)" class="p-2 rounded w-full text-black mb-3">

  <button id="createPollBtn" class="bg-green-500 px-4 py-2 rounded font-bold hover:bg-green-600 transition w-full">Create Poll</button>

  <div id="pollInfo" class="hidden mt-4 bg-indigo-700 p-4 rounded-lg text-center">
    <h3 class="font-semibold mb-2">Poll Created!</h3>
    <p>Share this link:</p>
    <a id="pollLink" href="#" class="underline text-blue-300" target="_blank"></a>
    <p class="mt-2">Or scan QR code:</p>
    <canvas id="pollQR" class="mx-auto mt-2"></canvas>
  </div>

  <div class="mt-6">
    <h2 class="text-xl font-semibold mb-2">Live Results</h2>
    <canvas id="resultsChart" class="rounded-lg shadow-lg bg-indigo-800 p-4"></canvas>
  </div>
</div>

<!-- PARTICIPANT PANEL -->
<div id="participantPanel" class="max-w-3xl mx-auto bg-purple-800 p-6 rounded-lg shadow-lg mt-8 hidden">
  <h2 id="participantTitle" class="text-2xl font-semibold mb-4 text-center"></h2>
  <div id="timerBar" class="w-full bg-purple-700 rounded-full h-4 mb-4 overflow-hidden hidden">
    <div id="timerProgress" class="bg-green-400 h-4 w-full transition-all"></div>
  </div>
  <form id="pollForm" class="space-y-4"></form>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  let poll = null;
  let pollResults = {};
  let resultsChart = null;

  const hostPanel = document.getElementById("hostPanel");
  const participantPanel = document.getElementById("participantPanel");

  const questionsContainer = document.getElementById("questionsContainer");
  const addQuestionBtn = document.getElementById("addQuestionBtn");
  const createPollBtn = document.getElementById("createPollBtn");
  const pollInfo = document.getElementById("pollInfo");
  const pollLink = document.getElementById("pollLink");
  const pollQR = document.getElementById("pollQR");
  const resultsCtx = document.getElementById("resultsChart").getContext("2d");

  const pollForm = document.getElementById("pollForm");
  const participantTitle = document.getElementById("participantTitle");
  const timerBar = document.getElementById("timerBar");
  const timerProgress = document.getElementById("timerProgress");

  // --------- HOST: Add Question ---------
  addQuestionBtn.addEventListener("click", () => {
    const qDiv = document.createElement("div");
    qDiv.className = "bg-indigo-700 p-3 rounded space-y-2";

    qDiv.innerHTML = `
      <input type="text" placeholder="Question" class="p-2 rounded w-full text-black questionInput">
      <div class="optionsContainer space-y-1"></div>
      <button type="button" class="addOptionBtn bg-blue-400 px-2 py-1 rounded hover:bg-blue-500 transition">Add Option</button>
    `;

    const addOptionBtn = qDiv.querySelector(".addOptionBtn");
    const optionsContainer = qDiv.querySelector(".optionsContainer");

    addOptionBtn.addEventListener("click", () => {
      const optInput = document.createElement("input");
      optInput.type = "text";
      optInput.placeholder = "Option text";
      optInput.className = "p-2 rounded w-full text-black";
      optionsContainer.appendChild(optInput);
    });

    questionsContainer.appendChild(qDiv);
  });

  // --------- HOST: Create Poll ---------
  createPollBtn.addEventListener("click", () => {
    const title = document.getElementById("pollTitle").value.trim();
    const allowAnonymous = document.getElementById("allowAnonymous").checked;
    const timer = parseInt(document.getElementById("pollTimer").value) || 0;

    const questions = [];
    document.querySelectorAll(".questionInput").forEach(q => {
      const options = [];
      q.parentElement.querySelectorAll(".optionsContainer input").forEach(opt => {
        if (opt.value.trim() !== "") options.push(opt.value.trim());
      });
      if (q.value.trim() && options.length > 0) questions.push({ question: q.value.trim(), options });
    });

    if (!title || questions.length === 0) return alert("Enter title and at least one question with options");

    poll = { title, questions, allowAnonymous, timer };
    pollResults = {};
    poll.questions.forEach((q, i) => pollResults[i] = Array(q.options.length).fill(0));

    // Encode poll in URL
    const encodedPoll = btoa(JSON.stringify(poll));
    const pollLinkURL = location.href.split("?")[0] + "?pollData=" + encodedPoll;

    pollLink.href = pollLinkURL;
    pollLink.textContent = pollLinkURL;
    pollInfo.style.display = "block";

    QRCode.toCanvas(pollQR, pollLinkURL, { width: 180 });

    // Initialize chart
    if(resultsChart) resultsChart.destroy();
    resultsChart = new Chart(resultsCtx, {
      type: "bar",
      data: {
        labels: poll.questions.map(q => q.question),
        datasets: [{
          label: 'Votes',
          data: poll.questions.map(() => 0),
          backgroundColor: 'rgba(34,197,94,0.7)',
          borderColor: 'rgba(34,197,94,1)',
          borderWidth: 1
        }]
      },
      options: { responsive: true, scales: { y: { beginAtZero: true } } }
    });
  });

  // --------- PARTICIPANT: Load from URL ---------
  const urlParams = new URLSearchParams(window.location.search);
  if(urlParams.get("pollData")) {
    try {
      poll = JSON.parse(atob(urlParams.get("pollData")));
    } catch(e) { alert("Invalid poll link"); return; }

    hostPanel.style.display = "none";
    participantPanel.style.display = "block";
    participantTitle.textContent = poll.title;

    // Initialize pollResults for participant view
    pollResults = {};
    poll.questions.forEach((q,i) => pollResults[i] = Array(q.options.length).fill(0));

    // Timer
    if(poll.timer && poll.timer > 0) {
      timerBar.style.display = "block";
      let timeLeft = poll.timer;
      const interval = setInterval(()=>{
        const pct = (timeLeft/poll.timer)*100;
        timerProgress.style.width = pct+"%";
        timeLeft--;
        if(timeLeft<0){
          clearInterval(interval);
          pollForm.querySelectorAll("input, button").forEach(el=>el.disabled=true);
          alert("Time is up!");
        }
      },1000);
    }

    // Generate form
    poll.questions.forEach((q,qi)=>{
      const div = document.createElement("div");
      div.className="space-y-2";
      div.innerHTML=`<p class="font-semibold text-lg">${q.question}</p>`;
      q.options.forEach((opt,oi)=>{
        const label = document.createElement("label");
        label.className="block";
        label.innerHTML=`<input type="radio" name="q${qi}" value="${oi}" class="mr-2"> ${opt}`;
        div.appendChild(label);
      });
      pollForm.appendChild(div);
    });

    if(!poll.allowAnonymous){
      const nameInput = document.createElement("input");
      nameInput.placeholder="Your name";
      nameInput.className="p-2 rounded w-full text-black";
      nameInput.id="userName";
      pollForm.appendChild(nameInput);
    }

    const submitBtn = document.createElement("button");
    submitBtn.type="submit";
    submitBtn.className="bg-green-500 px-4 py-2 rounded font-bold hover:bg-green-600 transition";
    submitBtn.textContent="Submit";
    pollForm.appendChild(submitBtn);

    // Add submit listener
    pollForm.addEventListener("submit", (e)=>{
      e.preventDefault();
      const deviceKey="pollix-submitted";
      if(localStorage.getItem(deviceKey)) return alert("You already submitted!");

      poll.questions.forEach((q,qi)=>{
        const sel = pollForm.querySelector(`input[name=q${qi}]:checked`);
        if(sel) pollResults[qi][parseInt(sel.value)]++;
      });

      localStorage.setItem(deviceKey,"true");
      pollForm.innerHTML="<p class='text-center text-lg'>Thanks for submitting!</p>";
    });
  }

});
</script>
</body>
</html>

